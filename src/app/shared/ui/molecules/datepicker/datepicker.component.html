<div class="datepicker-container" (clickOutside)="close()">

  <!-- Trigger Input -->
  <div class="datepicker-trigger" (click)="toggle()">
    <app-floating-input [label]="label" [value]="formattedValue()" [variant]="variant" [disabled]="disabled"
      [readonly]="true" [error]="error" class="pointer-events-none"></app-floating-input>

    <!-- Custom Trigger Icon -->
    <button type="button" class="calendar-icon-btn text-gray-400" tabindex="-1">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
        <path d="M8 14h.01"></path>
        <path d="M12 14h.01"></path>
        <path d="M16 14h.01"></path>
        <path d="M8 18h.01"></path>
        <path d="M12 18h.01"></path>
        <path d="M16 18h.01"></path>
      </svg>
    </button>
  </div>

  <!-- Popup Calendar -->
  @if (isOpen()) {
  <div class="datepicker-popup">
    <!-- Header -->
    <!-- Header -->
    <div class="calendar-header">
      <button class="nav-btn flex items-center justify-center p-1 hover:bg-gray-100 rounded-full transition-colors"
        (click)="prev($event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6" />
        </svg>
      </button>

      <div class="current-month font-semibold flex gap-1">
        <!-- Month Button -->
        <button type="button" class="px-2 py-1 rounded hover:bg-gray-100 font-semibold text-sm transition-colors"
          (click)="setView('month', $event)">
          {{ currentViewDate() | date:'MMMM' }}
        </button>
        <!-- Year Button -->
        <button type="button" class="px-2 py-1 rounded hover:bg-gray-100 font-semibold text-sm transition-colors"
          (click)="setView('year', $event)">
          {{ currentViewDate() | date:'yyyy' }}
        </button>
      </div>

      <button class="nav-btn flex items-center justify-center p-1 hover:bg-gray-100 rounded-full transition-colors"
        (click)="next($event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m9 18 6-6-6-6" />
        </svg>
      </button>
    </div>

    <!-- Day Grid (Default) -->
    @if (currentView() === 'day') {
    <div class="calendar-grid">
      <!-- Weekdays -->
      @for (day of weekDays; track day) {
      <div class="weekday-label text-xs text-gray-500 font-medium text-center py-1">{{ day }}</div>
      }

      <!-- Empty Slots -->
      @for (empty of emptyPrefixDays(); track $index) {
      <div class="calendar-day empty"></div>
      }

      <!-- Days -->
      @for (day of daysInMonth(); track $index) {
      <div class="calendar-day" [class.today]="isToday(day)" [class.selected]="isSelected(day)"
        (click)="selectDate(day)">
        {{ day.getDate() }}
      </div>
      }
    </div>
    }

    <!-- Month Grid -->
    @if (currentView() === 'month') {
    <div class="month-grid">
      @for (month of months; track $index) {
      <button type="button" class="calendar-option" [class.selected]="currentViewDate().getMonth() === $index"
        (click)="selectMonth($index)">
        {{ month.slice(0, 3) }}
      </button>
      }
    </div>
    }

    <!-- Year Grid -->
    @if (currentView() === 'year') {
    <div class="year-grid">
      @for (year of yearsList(); track year) {
      <button type="button" class="calendar-option" [class.selected]="currentViewDate().getFullYear() === year"
        (click)="selectYear(year)">
        {{ year }}
      </button>
      }
    </div>
    }
  </div>
  }
</div>